{% load static %}
<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ü—Ä–æ—Ñ—ñ–ª—å</title>
    <link rel="stylesheet" href="{% static 'css/profile.css' %}" />
    <style>
      input[type="file"] {
        display: none;
      }
      .edit-btn {
        margin-top: 10px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="logo">
        <div class="logo-bg">
          <img src="../../static/img/logo.png" alt="–Ü–∫–æ–Ω–∫–∞" />
        </div>
      </div>
      <nav class="navigation">
        <ul>
          <li><a href="{% url 'home' %}">–ì–æ–ª–æ–≤–Ω–∞</a></li>
          <li><a href="{% url 'about' %}">–ü—Ä–æ –Ω–∞—Å</a></li>
          <li><a href="{%url 'instruction'%}">–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è</a></li>
          <li><a href="{%url 'log_in'%}">–í—Ö—ñ–¥</a></li>
          <li><a href="{%url 'sign_up'%}">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</a></li>
          <li><a href="{%url 'zayavki'%}">–ó–∞—è–≤–∫–∏</a></li>
          
        </ul>
      </nav>
      <div class="profile">
        <a href="{% url 'profile' %}">–ü—Ä–æ—Ñ—ñ–ª—å</a>
      </div>
    </header>

    <main class="profile-page">
      <section class="profile-container">
        <div class="profile-left">
          <div class="avatar">
            {% if profile_user.avatar %}
              <img id="avatarImage" src="{{ profile_user.avatar.url }}" alt="–ê–≤–∞—Ç–∞—Ä" />
            {% else %}
              <img id="avatarImage" src="{% static 'img/default_avatar.png' %}" alt="–ê–≤–∞—Ç–∞—Ä" />
            {% endif %}
            
          </div>
          <div class="personal-info">
            <h2>{{ profile_user.fullname }}</h2>
            <p>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á:{{ profile_user.username }}</p>
            <p>Email: {{ profile_user.email }}</p>
            <p>–¢–µ–ª–µ—Ñ–æ–Ω: {{ profile_user.phone }}</p>
            <p>–ü—Ä–æ —Å–µ–±–µ:{{ profile_user.about }}</p>
          </div>    
          
          <!-- –ö–Ω–æ–ø–∫–∞ -->
          {% if is_own_profile %}
            <button id="editProfileBtn">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</button>
          {% endif %}
          <div class="modal-overlay" id="modalOverlay"></div>

          <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ -->
          <div id="editProfileModal" style="display:none;">
            <h3>–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é</h3>
            <button type="button" id="closeModal">&times;</button>
            <form id="editProfileForm" method="post" enctype="multipart/form-data">
              {% csrf_token %}
              <div id="formContent"></div>
              <button type="submit">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
              
            </form>
          </div>


          <form action="{% url 'logout' %}" method="post">
              {% csrf_token %}
              {% if is_own_profile %}
                <button type="submit" class="logout-btn">–í–∏–π—Ç–∏</button>
              {% endif %}
          </form>
        </div>
        
        <div class="profile-right">
          <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
          <div class="stats-grid">
            <div class="stat-box">
              <h3>–ü—Ä–∏–π–Ω—è—Ç–æ –∑–∞—è–≤–æ–∫</h3>
              <p>5</p>
            </div>
            <div class="stat-box">
              <h3>–ü–æ–¥–∞–Ω–æ –∑–∞—è–≤–æ–∫</h3>
              <p>3</p>
            </div>
            <div class="stat-box">
              <h3>–ù–∞—Ä–∞—Ö–æ–≤–∞–Ω–æ –±–æ–Ω—É—Å—ñ–≤</h3>
              <p>70</p>
            </div>
          </div>

          <h2>–Ü—Å—Ç–æ—Ä—ñ—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ</h2>
          <ul class="history">
            <li>‚úÖ –ü—Ä–∏–π–Ω—è—Ç–æ –∑–∞—è–≤–∫—É (–º–µ–¥–∏—á–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞) ‚Äî +20 –±–æ–Ω—É—Å—ñ–≤</li>
            <li>‚úÖ –ü—Ä–∏–π–Ω—è—Ç–æ –∑–∞—è–≤–∫—É (–ø–æ–∫—É–ø–∫–∏) ‚Äî +10 –±–æ–Ω—É—Å—ñ–≤</li>
            <li>üì§ –ü–æ–¥–∞–Ω–æ –∑–∞—è–≤–∫—É (–¥–æ–ø–æ–º–æ–≥–∞ –∑ –ª—ñ–∫–∞–º–∏)</li>
          </ul>
        </div>
      </section>

      <h3>–ü–æ–¥–∞–Ω—ñ –∑–∞—è–≤–∫–∏</h3>
      {% if applications %}
        <div class="application-grid">
          {% for req in applications  %}
              <div class="application-card">
                  <h3>{{ req.title }}</h3>
                  <p>{{ req.description|truncatewords:20 }}</p>
                  <p><strong>–ê–¥—Ä–µ—Å–∞:</strong> {{ req.address }}</p>
                  <p><small>{{ req.created_at|date:"d.m.Y" }}</small></p>
                  <p><strong>–°—Ç–∞—Ç—É—Å:</strong>
                    {% if req.status == 'pending' %} –û—á—ñ–∫—É—î
                    {% elif req.status == 'in_progress' %} –í –ø—Ä–æ—Ü–µ—Å—ñ
                    {% elif req.status == 'completed' %} –ó–∞–≤–µ—Ä—à–µ–Ω–æ
                    {% endif %}
                  </p>
                  <a href="{% url 'detail_zayavki' pk=req.pk %}" class="button-link">–î–µ—Ç–∞–ª—å–Ω—ñ—à–µ</a>
                  {% if req.status == 'in_progress' %}             
                    <form method="post" action="{% url 'creator_complete_request' req.id %}">
                      {% csrf_token %}
                      {% if is_own_profile %}
                        <button type="submit">–ó–∞–≤–µ—Ä—à–∏—Ç–∏</button>
                      {% endif %}
                    </form>
                  {% endif %}
                  <form method="post" action="{% url 'delete_request' req.pk %}" style="margin-top: 5px;">
                    {% csrf_token %}
                    {% if is_own_profile %}
                      <button type="submit" onclick="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –∑–∞—è–≤–∫—É?');">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                    {% endif %}
                  </form>
              </div>
          {% endfor %}
      </div>
      {% else %}
          <p>–£ –≤–∞—Å —â–µ –Ω–µ–º–∞—î –∑–∞—è–≤–æ–∫.</p>
      {% endif %}

      <h3>–ü—Ä–∏–π–Ω—è—Ç—ñ –∑–∞—è–≤–∫–∏</h3>
      {% if accepted_requests %}
          <div class="accepted-requests-container">
              {% for req in accepted_requests %}
                  <div class="accepted-request-card">
                      <h4>{{ req.title }} 
                          <span class="status-badge status-{{ req.status }}">
                              {% if req.status == 'pending' %}–û—á—ñ–∫—É—î
                              {% elif req.status == 'in_progress' %}–í –ø—Ä–æ—Ü–µ—Å—ñ
                              {% elif req.status == 'completed' %}–ó–∞–≤–µ—Ä—à–µ–Ω–æ
                              {% endif %}
                          </span>
                      </h4>
                      <p>{{ req.description|truncatewords:20 }}</p>
                      <p><strong>–ê–¥—Ä–µ—Å–∞:</strong> {{ req.address }}</p>
                      <p><small>–°—Ç–≤–æ—Ä–µ–Ω–æ: {{ req.created_at|date:"d.m.Y" }}</small></p>
                      <a href="{% url 'detail_zayavki' pk=req.pk %}">–î–µ—Ç–∞–ª—å–Ω—ñ—à–µ</a>
                  </div>
              {% endfor %}
          </div>
      {% else %}
          <div class="empty-state">
              <p>–ù–µ–º–∞—î –ø—Ä–∏–π–Ω—è—Ç–∏—Ö –∑–∞—è–≤–æ–∫.</p>
          </div>
      {% endif %}
    </main>
  </body>
</html>
<script>
document.getElementById('editProfileBtn').onclick = function () {
  fetch("{% url 'update_profile' %}", {
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  })
  .then(response => response.text())
  .then(html => {
    document.getElementById('formContent').innerHTML = html;
    document.getElementById('editProfileModal').style.display = 'block';
    document.getElementById('modalOverlay').style.display = 'block';
  });
};

document.getElementById('closeModal').onclick = function () {
  document.getElementById('editProfileModal').style.display = 'none';
  document.getElementById('modalOverlay').style.display = 'none';
};

document.getElementById('editProfileForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const formData = new FormData(this);

  fetch("{% url 'update_profile' %}", {
    method: 'POST',
    body: formData,
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload();  // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é
    } else {
      document.getElementById('formContent').innerHTML = data.form_html;
    }
  });
});
</script>